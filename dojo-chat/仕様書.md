# dojo-chat プロジェクト仕様書

## 目次
1. [プロジェクト概要](#プロジェクト概要)
2. [システムアーキテクチャ](#システムアーキテクチャ)
3. [技術スタック](#技術スタック)
4. [ディレクトリ構造](#ディレクトリ構造)
5. [機能仕様](#機能仕様)
6. [API仕様](#api仕様)
7. [データモデル](#データモデル)
8. [環境設定](#環境設定)
9. [開発・デプロイ](#開発デプロイ)
10. [今後の課題と拡張](#今後の課題と拡張)

---

## プロジェクト概要

**プロジェクト名**: dojo-chat

**目的**: Google Gemini AIを活用した対話型チャットアプリケーション

**現在のステータス**: プロトタイプ段階（基本的なチャット機能実装済み）

**主要機能**:
- Google Gemini 2.5 Flash モデルとのリアルタイム対話
- モダンなチャットUI（サイドバー、メッセージ表示、入力欄）
- チャット履歴表示（現在は固定値）
- ダーク/ライトモード対応
- ファイルアップロード機能（UI実装済み）

---

## システムアーキテクチャ

```mermaid
graph TB
    subgraph "クライアント層"
        UI[Next.js Frontend<br/>localhost:3000]
    end

    subgraph "サーバー層"
        API[FastAPI Backend<br/>localhost:8080]
    end

    subgraph "外部サービス"
        GEMINI[Google Gemini API<br/>gemini-2.5-flash]
    end

    UI -->|HTTP POST /ask| API
    API -->|generate_content| GEMINI
    GEMINI -->|AI Response| API
    API -->|JSON Response| UI

    style UI fill:#61dafb,stroke:#333,stroke-width:2px
    style API fill:#009688,stroke:#333,stroke-width:2px
    style GEMINI fill:#4285f4,stroke:#333,stroke-width:2px
```

### システムフロー

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Backend
    participant Gemini

    User->>Frontend: メッセージ入力
    Frontend->>Frontend: メッセージをstateに追加
    Frontend->>Backend: POST /ask {question}
    Backend->>Backend: リクエスト検証
    Backend->>Gemini: generate_content(question)
    Gemini-->>Backend: AI応答テキスト
    Backend-->>Frontend: {answer: string}
    Frontend->>Frontend: 応答をstateに追加
    Frontend-->>User: メッセージ表示

    Note over Backend,Gemini: エラー時は{error: string}を返す
```

---

## 技術スタック

### フロントエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| Next.js | 16.0.6 | Reactフレームワーク |
| React | 19.2.0 | UIライブラリ |
| TypeScript | 5 | 型安全な開発 |
| Tailwind CSS | 4 | スタイリング |
| ESLint | 9 | コード品質管理 |

### バックエンド

| 技術 | 用途 |
|------|------|
| FastAPI | Web APIフレームワーク |
| Uvicorn | ASGIサーバー |
| Pydantic | データ検証 |
| Google Generative AI | Gemini API SDK |
| python-dotenv | 環境変数管理 |

### インフラ・開発環境

```mermaid
graph LR
    DEV[開発環境] --> FRONT[Next.js Dev Server<br/>Port: 3000]
    DEV --> BACK[Uvicorn Server<br/>Port: 8080]
    BACK --> ENV[.env<br/>GEMINI_API_KEY]

    style DEV fill:#f9f,stroke:#333,stroke-width:2px
    style FRONT fill:#61dafb,stroke:#333,stroke-width:2px
    style BACK fill:#009688,stroke:#333,stroke-width:2px
```

---

## ディレクトリ構造

```mermaid
graph TD
    ROOT[dojo-chat/]

    ROOT --> FRONT[フロントエンド/]
    ROOT --> BACK[バックエンド/]
    ROOT --> SPEC[仕様書.md]

    FRONT --> APP[app/]
    FRONT --> PUBLIC[public/]
    FRONT --> CONFIG1[package.json]
    FRONT --> CONFIG2[tsconfig.json]
    FRONT --> CONFIG3[next.config.ts]

    APP --> PAGE[page.tsx]
    APP --> LAYOUT[layout.tsx]
    APP --> CSS[globals.css]

    BACK --> API[api.py]
    BACK --> ENVFILE[.env]

    style ROOT fill:#f5f5f5,stroke:#333,stroke-width:3px
    style FRONT fill:#e3f2fd,stroke:#333,stroke-width:2px
    style BACK fill:#e8f5e9,stroke:#333,stroke-width:2px
    style PAGE fill:#ffeb3b,stroke:#333,stroke-width:1px
    style API fill:#ffeb3b,stroke:#333,stroke-width:1px
```

### 詳細構造

```
dojo-chat/
│
├── フロントエンド/
│   ├── app/
│   │   ├── page.tsx          # メインチャットUIコンポーネント (217行)
│   │   ├── layout.tsx        # ルートレイアウト定義
│   │   ├── globals.css       # グローバルスタイル
│   │   └── favicon.ico       # ファビコン
│   │
│   ├── public/               # 静的アセット
│   │   ├── file.svg
│   │   ├── globe.svg
│   │   ├── next.svg
│   │   ├── vercel.svg
│   │   └── window.svg
│   │
│   ├── package.json          # 依存関係定義
│   ├── tsconfig.json         # TypeScript設定
│   ├── next.config.ts        # Next.js設定
│   ├── postcss.config.mjs    # PostCSS/Tailwind設定
│   ├── eslint.config.mjs     # ESLint設定
│   ├── README.md             # プロジェクト説明
│   └── .gitignore
│
└── バックエンド/
    ├── api.py                # FastAPI アプリケーション (50行)
    ├── .env                  # 環境変数（GEMINI_API_KEY）
    └── .claude/              # Claude設定ディレクトリ
```

---

## 機能仕様

### 1. チャットインターフェース

```mermaid
graph LR
    subgraph "チャットUI構成"
        SIDEBAR[サイドバー]
        MAIN[メインエリア]
        INPUT[入力エリア]
    end

    SIDEBAR --> NEW[新規チャットボタン]
    SIDEBAR --> HISTORY[チャット履歴リスト]
    SIDEBAR --> PROFILE[ユーザープロフィール]

    MAIN --> WELCOME[ウェルカムメッセージ]
    MAIN --> MESSAGES[メッセージ表示エリア]

    INPUT --> TEXTBOX[テキスト入力欄]
    INPUT --> UPLOAD[ファイルアップロード]
    INPUT --> SEND[送信ボタン]

    style SIDEBAR fill:#f3f4f6,stroke:#333
    style MAIN fill:#fff,stroke:#333
    style INPUT fill:#e5e7eb,stroke:#333
```

### 2. 機能一覧

| 機能 | 実装状況 | 説明 |
|------|---------|------|
| メッセージ送信 | ✅ 実装済み | ユーザーメッセージをGemini APIに送信 |
| AI応答表示 | ✅ 実装済み | Geminiからの応答を表示 |
| チャット履歴表示 | 🔶 部分実装 | UIは実装済みだが固定値 |
| 新規チャット作成 | 🔶 部分実装 | ボタンは存在するが機能未実装 |
| ファイルアップロード | 🔶 部分実装 | UIのみ実装 |
| エラーハンドリング | ✅ 実装済み | try-catchでエラーを捕捉 |
| ダーク/ライトモード | ✅ 実装済み | Tailwindで対応 |
| レスポンシブデザイン | ✅ 実装済み | モバイル対応 |
| ユーザー認証 | ❌ 未実装 | 今後の課題 |
| メッセージ永続化 | ❌ 未実装 | データベース未導入 |

### 3. ユーザーフロー

```mermaid
flowchart TD
    START([ユーザーがアプリ起動])
    START --> LOAD[ページ読み込み]
    LOAD --> WELCOME[ウェルカム画面表示]

    WELCOME --> INPUT{メッセージ入力}
    INPUT --> SEND[送信ボタンクリック]
    SEND --> VALIDATE{入力検証}

    VALIDATE -->|空文字| INPUT
    VALIDATE -->|有効| API[API呼び出し]

    API --> LOADING[ローディング表示]
    LOADING --> RESPONSE{API応答}

    RESPONSE -->|成功| DISPLAY[メッセージ表示]
    RESPONSE -->|エラー| ERROR[エラー表示]

    DISPLAY --> INPUT
    ERROR --> INPUT

    style START fill:#4caf50,stroke:#333,stroke-width:2px,color:#fff
    style DISPLAY fill:#2196f3,stroke:#333,stroke-width:2px,color:#fff
    style ERROR fill:#f44336,stroke:#333,stroke-width:2px,color:#fff
```

---

## API仕様

### エンドポイント一覧

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| GET | `/` | ヘルスチェック | 不要 |
| POST | `/ask` | AI質問応答 | 不要 |

### 1. ヘルスチェック

**エンドポイント**: `GET /`

**レスポンス**:
```json
{
  "message": "hello"
}
```

**ステータスコード**: `200 OK`

### 2. AI質問応答

**エンドポイント**: `POST /ask`

**リクエスト**:
```json
{
  "question": "string"
}
```

**レスポンス（成功時）**:
```json
{
  "answer": "string"
}
```

**レスポンス（エラー時）**:
```json
{
  "error": "string"
}
```

**ステータスコード**:
- `200 OK` - 正常応答
- `422 Unprocessable Entity` - バリデーションエラー
- `500 Internal Server Error` - サーバーエラー

### APIフロー詳細

```mermaid
flowchart TD
    REQ[POST /ask]
    REQ --> VALIDATE{Pydantic検証}

    VALIDATE -->|失敗| ERR422[422 Error<br/>バリデーションエラー]
    VALIDATE -->|成功| GEMINI[Gemini API呼び出し]

    GEMINI --> TRY{例外処理}
    TRY -->|成功| SUCCESS[200 OK<br/>{answer: string}]
    TRY -->|失敗| ERR500[200 OK<br/>{error: string}]

    style REQ fill:#2196f3,stroke:#333,stroke-width:2px,color:#fff
    style SUCCESS fill:#4caf50,stroke:#333,stroke-width:2px,color:#fff
    style ERR422 fill:#ff9800,stroke:#333,stroke-width:2px,color:#fff
    style ERR500 fill:#f44336,stroke:#333,stroke-width:2px,color:#fff
```

### CORS設定

```python
allow_origins = ["http://localhost:3000"]
allow_credentials = True
allow_methods = ["*"]
allow_headers = ["*"]
```

---

## データモデル

### フロントエンド（TypeScript）

```typescript
// メッセージ型定義
interface Message {
  role: "user" | "assistant";
  content: string;
}

// チャット履歴型定義（現在は固定値）
interface Chat {
  id: string;
  title: string;
  timestamp: string;
}
```

### バックエンド（Python）

```python
from pydantic import BaseModel

class QuestionRequest(BaseModel):
    question: str
```

### データフロー

```mermaid
graph LR
    subgraph Frontend
        STATE[React State<br/>messages: Message[]]
    end

    subgraph Backend
        PYDANTIC[Pydantic Model<br/>QuestionRequest]
    end

    subgraph External
        GEMINI[Gemini API]
    end

    STATE -->|JSON| PYDANTIC
    PYDANTIC -->|question| GEMINI
    GEMINI -->|text| PYDANTIC
    PYDANTIC -->|JSON| STATE

    style STATE fill:#61dafb,stroke:#333,stroke-width:2px
    style PYDANTIC fill:#009688,stroke:#333,stroke-width:2px
    style GEMINI fill:#4285f4,stroke:#333,stroke-width:2px
```

### データベーススキーマ（予定）

現在はデータベース未実装ですが、将来的な実装案:

```mermaid
erDiagram
    USERS ||--o{ CHATS : creates
    CHATS ||--o{ MESSAGES : contains

    USERS {
        uuid id PK
        string email
        string name
        timestamp created_at
    }

    CHATS {
        uuid id PK
        uuid user_id FK
        string title
        timestamp created_at
        timestamp updated_at
    }

    MESSAGES {
        uuid id PK
        uuid chat_id FK
        enum role
        text content
        timestamp created_at
    }
```

---

## 環境設定

### フロントエンド環境変数

現在は使用していませんが、今後必要になる可能性のある環境変数:

```env
NEXT_PUBLIC_API_URL=http://localhost:8080
```

### バックエンド環境変数

**ファイル**: `バックエンド/.env`

```env
GEMINI_API_KEY=********************************
```

### 設定ファイル

#### TypeScript設定（tsconfig.json）

```json
{
  "compilerOptions": {
    "strict": true,
    "paths": {
      "@/*": ["./*"]
    }
  }
}
```

#### Next.js設定（next.config.ts）

```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {};

export default nextConfig;
```

#### Tailwind CSS設定（postcss.config.mjs）

```javascript
export default {
  plugins: {
    '@tailwindcss/postcss': {},
  },
};
```

---

## 開発・デプロイ

### 開発環境セットアップ

```mermaid
flowchart TD
    START([開発開始])

    subgraph "フロントエンド"
        F1[npm install]
        F2[npm run dev]
        F3[localhost:3000で起動]
    end

    subgraph "バックエンド"
        B1[pip install -r requirements.txt]
        B2[.env ファイル作成]
        B3[uvicorn api:app --reload --port 8080]
        B4[localhost:8080で起動]
    end

    START --> F1
    START --> B1
    F1 --> F2
    F2 --> F3
    B1 --> B2
    B2 --> B3
    B3 --> B4

    F3 --> READY[開発環境Ready]
    B4 --> READY

    style START fill:#4caf50,stroke:#333,stroke-width:2px,color:#fff
    style READY fill:#2196f3,stroke:#333,stroke-width:2px,color:#fff
```

### npm スクリプト（フロントエンド）

```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  }
}
```

### 起動手順

#### 1. フロントエンド起動

```bash
cd フロントエンド
npm install
npm run dev
```

アクセス: http://localhost:3000

#### 2. バックエンド起動

```bash
cd バックエンド
pip install fastapi uvicorn google-generativeai python-dotenv
uvicorn api:app --reload --port 8080
```

アクセス: http://localhost:8080

---

## 今後の課題と拡張

### 優先度：高

```mermaid
mindmap
  root((今後の課題))
    認証・認可
      ユーザー登録/ログイン
      JWT実装
      セッション管理
    データ永続化
      PostgreSQL導入
      チャット履歴保存
      ユーザーデータ管理
    セキュリティ
      APIキー保護
      入力サニタイズ
      CSRF対策
```

### 課題一覧

| 優先度 | カテゴリ | 課題 | 説明 |
|-------|---------|------|------|
| 🔴 高 | データベース | DB導入 | PostgreSQL/MongoDB導入 |
| 🔴 高 | 認証 | ユーザー認証 | JWT/OAuth実装 |
| 🔴 高 | セキュリティ | APIキー保護 | 環境変数の適切な管理 |
| 🟡 中 | 機能 | チャット履歴 | 過去の会話の保存・読み込み |
| 🟡 中 | 機能 | ファイルアップロード | 画像・ドキュメント送信 |
| 🟡 中 | UX | ストリーミング応答 | リアルタイム応答表示 |
| 🟢 低 | テスト | テストコード | Unit/Integration tests |
| 🟢 低 | デプロイ | CI/CD | 自動デプロイパイプライン |

### 拡張機能案

```mermaid
graph TD
    CURRENT[現在の機能]

    CURRENT --> AUTH[認証システム]
    CURRENT --> DB[データベース]
    CURRENT --> STREAM[ストリーミング]
    CURRENT --> FILE[ファイル処理]

    AUTH --> GOOGLE[Google OAuth]
    AUTH --> EMAIL[メール認証]

    DB --> POSTGRES[PostgreSQL]
    DB --> REDIS[Redisキャッシュ]

    STREAM --> SSE[Server-Sent Events]
    STREAM --> WS[WebSocket]

    FILE --> IMAGE[画像解析]
    FILE --> PDF[PDF読み取り]

    style CURRENT fill:#4caf50,stroke:#333,stroke-width:3px,color:#fff
    style AUTH fill:#2196f3,stroke:#333,stroke-width:2px
    style DB fill:#ff9800,stroke:#333,stroke-width:2px
    style STREAM fill:#9c27b0,stroke:#333,stroke-width:2px
    style FILE fill:#f44336,stroke:#333,stroke-width:2px
```

### 技術的改善案

1. **パフォーマンス最適化**
   - レスポンスキャッシング
   - 画像最適化
   - コード分割

2. **エラーハンドリング強化**
   - より詳細なエラーメッセージ
   - リトライ機構
   - ログ管理システム

3. **コード品質向上**
   - TypeScript strict モード
   - ユニットテスト導入
   - コードカバレッジ測定

4. **監視・ロギング**
   - アプリケーションログ
   - エラートラッキング（Sentry等）
   - パフォーマンス監視

---

## まとめ

dojo-chatは、Google Gemini AIを活用したモダンなチャットアプリケーションのプロトタイプです。

**強み**:
- クリーンなアーキテクチャ
- モダンな技術スタック
- 拡張性の高い設計

**現状の制限**:
- データベース未実装
- 認証機能なし
- 基本的な機能のみ実装

今後、データ永続化、認証システム、高度な機能を追加することで、本格的なプロダクションレベルのチャットアプリケーションに成長させることが可能です。

---

**作成日**: 2025-12-22
**バージョン**: 1.0.0
**ステータス**: プロトタイプ段階
